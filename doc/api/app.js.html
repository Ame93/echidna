<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: app.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: app.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module
 */

/* eslint-disable no-console */

'use strict';

console.log('Launching…');

var meta = require('./package.json');
var express = require('express');
var compression = require('compression');
var bodyParser = require('body-parser');
var multer = require('multer');
var path = require('path');
var Fs = require('fs');
var Map = require('immutable').Map;
const { v4: uuidv4 } = require('uuid');

var Job = require('./lib/job');
var Orchestrator = require('./lib/orchestrator');
var RequestState = require('./lib/request-state');
var SpecberusWrapper = require('./lib/specberus-wrapper');
var mailer = require('./lib/mailer');

var passport = require('passport');
var LdapAuth = require('ldapauth-fork');
var BasicStrategy = require('passport-http').BasicStrategy;

// Configuration file
require('./config.js');

var app = express();
var requests = {};
var port = process.argv[4] || global.DEFAULT_PORT;
var argTempLocation = process.argv[2] || global.DEFAULT_TEMP_LOCATION;
var argHttpLocation = process.argv[3] || global.DEFAULT_HTTP_LOCATION;
var argResultLocation = process.argv[5] || global.DEFAULT_RESULT_LOCATION;

app.use(compression());
app.use(bodyParser.urlencoded({ extended: false }));
app.use(corsHandler);
app.use(express.static('assets/'));
app.set('json spaces', 2);

// Index Page
app.get('/', function (request, response) {
  response.sendFile(__dirname + '/views/index.html');
});

// New UI
app.get('/ui', function (request, response) {
  response.sendFile(__dirname + '/views/web-interface.html');
});

// API methods

app.get('/api/version', function (req, res) {
  res.send(meta.version);
});

app.get('/api/version-specberus', function (req, res) {
  res.send(SpecberusWrapper.version);
});

app.get('/api/status', function (req, res) {
  var id = req.query ? req.query.id : null;
  var file = argResultLocation + path.sep + id + '.json';

  if (id) {
    Fs.access(file, Fs.constants.F_OK, function (error) {
      if (!error)
        res.status(200).sendFile(file);
      else if (requests &amp;&amp; requests[id])
          res.status(200).json(requests[id]);
      else
        res.status(404).send('No job found with ID “' + id + '”.');
    });
  }
  else res.status(400).send('Missing required parameter “ID”.');
});

function dumpJobResult(dest, result) {
  Fs.writeFile(dest, JSON.stringify(result, null, 2) + '\n', function (err) {
    if (err) return console.error(err);
  });
}

/**
 * @function processRequest
 * @description Handler of user request. Distinguish if the request contains a tar file for a link to manifest.
 * @param {Object} req 
 * @param {Object} res 
 * @param {Boolean} isTar whether request contains a tar file
 */
var processRequest = function (req, res, isTar) {
  var id = uuidv4();
  var decision = req.body ? req.body.decision : null;
  var url = (!isTar &amp;&amp; req.body) ? req.body.url : null;
  var token = (!isTar &amp;&amp; req.body) ? req.body.token : null;
  var editorial = Boolean(req.body &amp;&amp; req.body.editorial &amp;&amp; /^true$/i.test(req.body.editorial));
  var tar = (isTar) ? req.file : null;
  var user = req.user ? req.user : null;
  var dryRun = Boolean(req.body &amp;&amp; req.body['dry-run'] &amp;&amp; /^true$/i.test(req.body['dry-run']));
  var ccEmail = req.body ? req.body.cc : null;

  if (!((url &amp;&amp; token) || tar) || !decision) {
    res.status(500).send(
      'Missing required parameters "url + token + decision"' +
      ' or "tar + decision".'
    );
  }
  else {
    var tempLocation = argTempLocation + path.sep + id + path.sep;
    var httpLocation = argHttpLocation + '/' + id + '/Overview.html';

    requests[id] = {};
    requests[id]['id'] = id;
    if (isTar) requests[id]['tar'] = tar.originalname;
    else requests[id]['url'] = url;
    requests[id]['version'] = meta.version;
    requests[id]['version-specberus'] = SpecberusWrapper.version;
    requests[id]['decision'] = decision;
    requests[id]['editorial'] = editorial;
    var jobList = ['retrieve-resources', 'metadata', 'specberus', 'transition-checker', 'third-party-checker', 'publish', 'tr-install', 'update-tr-shortlink'];

    if (isTar)
      jobList.splice(2, 0, 'user-checker');
    else
      jobList.splice(3, 0, 'token-checker');

    if (dryRun)
      jobList.splice(jobList.indexOf('publish'));

    requests[id]['results'] = new RequestState(
                  '',
                  new Map(jobList.reduce(function (o, v) {
                    o[v] = new Job();
                    return o;
                  }, {}))
                );

    var orchestrator = new Orchestrator(
      url,
      tar,
      token,
      editorial,
      user,
      tempLocation,
      httpLocation,
      argResultLocation
    );

    Orchestrator.iterate(
      function (state) {
        return orchestrator.next(state);
      },
      Orchestrator.hasFinished,
      function (state) {
        requests[id].results = state;
      },
      requests[id].results
    ).then(function (state) {
      console.log('[' + state.get('status').toUpperCase() + '] ' + url);
      dumpJobResult(argResultLocation + path.sep + id + '.json', requests[id]);
      if (dryRun)
        console.log('Dry-run: omitting e-mail notification');
      else {
        mailer.sendMessage(
          id,
          state,
          requests[id],
          url || tar.originalname,
          ccEmail
        );
      }
    }).done();

    res.status(202).send(id);
  }
};

passport.use(new BasicStrategy(
  function (username, password, done) {
    var opts = {
      url: global.LDAP_URL,
      bindDn: global.LDAP_BIND_DN.replace(/{{username}}/, username),
      bindCredentials: password,
      searchBase: global.LDAP_SEARCH_BASE,
      searchFilter: '(uid={{username}})',
      searchAttributes: ['memberOf'],
      cache: false
    };

    var ldap = new LdapAuth(opts);

    ldap.authenticate(username, password, function (err, user) {
      if (err) {
        console.log('LDAP auth error: %s', err);
      }
      done(null, user);
    });
  }
));

app.post('/api/request', function (req, res, next) {
  if (req.is('application/x-www-form-urlencoded')) {
    processRequest(req, res, false);
  }
  else if (req.is('multipart/form-data')) {
    next();
  }
  else {
    res.status(501)
       .send({ status: 'Form Content-Type not supported' });
  }
});

app.post(
  '/api/request',
  passport.authenticate('basic', { session: false }),
  multer().single('tar'),
  function (req, res) {
    processRequest(req, res, true);
  }
);

/**
* Add CORS headers to responses if the client is explicitly allowed.
*
* First, this ensures that the testbed page on the test server, listening on a different port, can GET and POST to Echidna.
* Most importantly, this is necessary to attend publication requests from third parties, eg GitHub.
*/

function corsHandler(req, res, next) {
  if (req &amp;&amp; req.headers &amp;&amp; req.headers.origin) {
    if (global.ALLOWED_CLIENTS.some(function (regex) {
      return regex.test(req.headers.origin);
    })) {
      res.header('Access-Control-Allow-Origin', req.headers.origin);
      res.header('Access-Control-Allow-Methods', 'GET,POST');
      res.header('Access-Control-Allow-Headers', 'Content-Type');
    }
  }
  next();
}

app.listen(process.env.PORT || port).on('error', function (err) {
  if (err) {
    console.error('Error while trying to launch the server: “' + err + '”.');
  }
});

console.log(
  meta.name +
  ' version ' + meta.version +
  ' running on ' + process.platform +
  ' and listening on port ' + port +
  '. The server time is ' + new Date().toLocaleTimeString() + '.'
);
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Welcome to Echidna</a></h2><h3>Modules</h3><ul><li><a href="module-app.html">app</a></li><li><a href="module-lib_document-downloader.html">lib/document-downloader</a></li><li><a href="module-lib_history.html">lib/history</a></li><li><a href="module-lib_job.html">lib/job</a></li><li><a href="module-lib_json-http-service.html">lib/json-http-service</a></li><li><a href="module-lib_orchestrator.html">lib/orchestrator</a></li><li><a href="module-lib_publisher.html">lib/publisher</a></li><li><a href="module-lib_request-state.html">lib/request-state</a></li><li><a href="module-lib_specberus-wrapper.html">lib/specberus-wrapper</a></li><li><a href="module-lib_third-party-resources-checker.html">lib/third-party-resources-checker</a></li><li><a href="module-lib_token-checker.html">lib/token-checker</a></li><li><a href="module-lib_transition-checker.html">lib/transition-checker</a></li><li><a href="module-lib_user-checker.html">lib/user-checker</a></li><li><a href="module-test_lib_BadRequestService.html">test/lib/BadRequestService</a></li><li><a href="module-test_lib_CreatedService.html">test/lib/CreatedService</a></li><li><a href="module-test_lib_htmlTemplate.html">test/lib/htmlTemplate</a></li><li><a href="module-test_lib_NotImplementedService.html">test/lib/NotImplementedService</a></li><li><a href="module-test_lib_ServerErrorService.html">test/lib/ServerErrorService</a></li><li><a href="module-test_lib_TestServer.html">test/lib/TestServer</a></li><li><a href="module-test_lib_utils_draftsSystemPath.html">test/lib/utils/draftsSystemPath</a></li><li><a href="module-test_lib_utils_getMetadata.html">test/lib/utils/getMetadata</a></li><li><a href="module-test_lib_utils_substitutions.html">test/lib/utils/substitutions</a></li><li><a href="module-test_lib_validator.html">test/lib/validator</a></li><li><a href="module-test_test.html">test/test</a></li><li><a href="module-test_test-history.html">test/test-history</a></li><li><a href="module-test_test-job.html">test/test-job</a></li><li><a href="module-test_test-json-http-service.html">test/test-json-http-service</a></li><li><a href="module-test_test-orchestrator.html">test/test-orchestrator</a></li><li><a href="module-test_test-request-state.html">test/test-request-state</a></li></ul><h3>Global</h3><ul><li><a href="global.html#sendMessage">sendMessage</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Fri Jul 10 2020 13:39:11 GMT+0800 (China Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
