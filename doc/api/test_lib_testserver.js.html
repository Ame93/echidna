<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: test/lib/testserver.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: test/lib/testserver.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

var fs = require('fs');
var express = require('express');
var app = express();
var morgan = require('morgan');
var cssvalidator = require('./cssvalidator');
var htmlvalidator = require('./htmlvalidator');
var tokenChecker = require('./tokenchecker');
var htmlTemplate = require('./htmltemplate');
var getMetadata = require('./utils').getMetadata;
var draftsSystemPath = require('./utils').draftsSystemPath;
var request = require('request');

var PublishService = require('./fake-http-services').CreatedService;
var port = (process.env.PORT || 3000) + 1;

/**
 * @exports test/lib/TestServer
 */

var TestServer = function () {};

app.use(morgan('dev', {
  stream: fs.createWriteStream('/tmp/echidna-testserver.log', { flags: 'w' })
}));

app.use(cssvalidator);
app.use(htmlvalidator);
app.use(tokenChecker);

// Setup the templating before using express static
app.use(htmlTemplate('/drafts', draftsSystemPath));
app.use('/drafts', express.static(draftsSystemPath));
app.use(express.static('assets/'));
app.use(express.static('test/views/'));

app.get('/data/specs.json', function (req, res) {
  var specs = [];
  var metadata;
  var listing = fs.readdirSync(draftsSystemPath);

  for (var i = 0; i &lt; listing.length; ++i) {
    metadata = getMetadata(listing[i]);
    if (metadata) specs.push({ id: listing[i], metadata: metadata });
    else throw new Error(
      'Spec “' + listing[i] + '” does not have associated metadata!'
    );
  }

  res.send({ specs: specs });
});

app.get('/robots', function (req, res) {
  res.send('&lt;!doctype html>&lt;p>Those are not the robots you are looking for.');
});

app.get('/elvis', function (req, res) {
  res.send('&lt;!doctype html>&lt;p>Elvis is alive.');
});

// Pseudo-endpoint for spec generator
app.get('/generate', function (req, res) {
  var type = (req.query.type || '').toLowerCase();
  var url = req.query.url;

  if (!url || !type) {
    return res.status(500).json({
      error: 'Both `type` and `url` are required.'
    });
  }
  if (type !== 'test') {
    return res.status(500).json({ error: 'Unknown type `' + type + '`' });
  }

  request(url, function (err, response, body) {
    res.send(body.replace('&lt;title>', '&lt;title>Spec-generated '));
  });
});

app.post('/publish', function (_, res) {
  new PublishService().post().then(function (out) {
    return res.status(out.response.statusCode).json(out.body);
  });
});

var server;

TestServer.start = function () {
  var limitPort = port + 30;

  do {
    server = app.listen(port).on('error', function (err) {
      // Only when there's an error because the port is already in use,
      // we simply continue trying.
      if ('EADDRINUSE' !== err.code) {
        throw new Error('Error while trying to launch the test server: ' + err);
      }
    });
    port += 1;
  } while (server.address() === null &amp;&amp; port &lt; limitPort);

  if (server.address() === null) {
    throw new Error('Cannot find a free port for the test server ' + port);
  }
  global.SPEC_GENERATOR = this.location() + '/generate';
};

TestServer.location = function () {
  if (server &amp;&amp; server.address()) {
    return 'http://localhost:' + server.address().port;
  }
};

// This will return metadata associate with a draft
TestServer.getMetadata = function (name) {
  var data = getMetadata(name);

  if (data.location === undefined) {
    data.location = this.location() + '/drafts/' + name + '/';
  }
  return data;
};

TestServer.close = () => server.close();

TestServer.start();

module.exports = TestServer;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Welcome to Echidna</a></h2><h3>Modules</h3><ul><li><a href="module-app.html">app</a></li><li><a href="module-lib_document-downloader.html">lib/document-downloader</a></li><li><a href="module-lib_history.html">lib/history</a></li><li><a href="module-lib_job.html">lib/job</a></li><li><a href="module-lib_json-http-service.html">lib/json-http-service</a></li><li><a href="module-lib_orchestrator.html">lib/orchestrator</a></li><li><a href="module-lib_publisher.html">lib/publisher</a></li><li><a href="module-lib_request-state.html">lib/request-state</a></li><li><a href="module-lib_specberus-wrapper.html">lib/specberus-wrapper</a></li><li><a href="module-lib_third-party-resources-checker.html">lib/third-party-resources-checker</a></li><li><a href="module-lib_token-checker.html">lib/token-checker</a></li><li><a href="module-lib_transition-checker.html">lib/transition-checker</a></li><li><a href="module-lib_user-checker.html">lib/user-checker</a></li><li><a href="module-test_lib_BadRequestService.html">test/lib/BadRequestService</a></li><li><a href="module-test_lib_CreatedService.html">test/lib/CreatedService</a></li><li><a href="module-test_lib_htmlTemplate.html">test/lib/htmlTemplate</a></li><li><a href="module-test_lib_NotImplementedService.html">test/lib/NotImplementedService</a></li><li><a href="module-test_lib_ServerErrorService.html">test/lib/ServerErrorService</a></li><li><a href="module-test_lib_TestServer.html">test/lib/TestServer</a></li><li><a href="module-test_lib_utils_draftsSystemPath.html">test/lib/utils/draftsSystemPath</a></li><li><a href="module-test_lib_utils_getMetadata.html">test/lib/utils/getMetadata</a></li><li><a href="module-test_lib_utils_substitutions.html">test/lib/utils/substitutions</a></li><li><a href="module-test_lib_validator.html">test/lib/validator</a></li><li><a href="module-test_test.html">test/test</a></li><li><a href="module-test_test-history.html">test/test-history</a></li><li><a href="module-test_test-job.html">test/test-job</a></li><li><a href="module-test_test-json-http-service.html">test/test-json-http-service</a></li><li><a href="module-test_test-orchestrator.html">test/test-orchestrator</a></li><li><a href="module-test_test-request-state.html">test/test-request-state</a></li></ul><h3>Global</h3><ul><li><a href="global.html#sendMessage">sendMessage</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Fri Jul 10 2020 13:39:11 GMT+0800 (China Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
