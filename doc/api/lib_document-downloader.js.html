<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: lib/document-downloader.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: lib/document-downloader.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file Download file from tar file or manifest url, called by orchestrator.js
 */
'use strict';

var Fs = require('fs');
var Request = require('request');
var List = require('immutable').List;
var Promise = require('promise');
var Url = require('url');
var Mkdirp = require('mkdirp');

/**
 * @exports lib/document-downloader
 */

var DocumentDownloader = {};

DocumentDownloader.fetch = function (url) {
  return new Promise(function (resolve, reject) {
    Request.get(url, {
      timeout: 30000,
      encoding: null // If not specified, utf8 by default
    }, function (error, response, body) {
      if (error) {
        reject(new Error(
          'Fetching ' + url + ' triggered a network error: ' + error.message
        ));
      }
      else if (response.statusCode !== 200) {
        reject(new Error(
          'Fetching ' + url +
          ' triggered an HTTP error: code ' + response.statusCode
        ));
      }
      else resolve(body);
    });
  });
};

DocumentDownloader.fetchAll = function (urls) {
  return Promise.all(urls.toArray().map(this.fetch)).then(List);
};

DocumentDownloader.install = function (dest, content) {
  var path = require('path').dirname(dest);

  Mkdirp.sync(path);
  return Promise.denodeify(Fs.writeFile)(dest, content);
};

DocumentDownloader.installAll = function (destsContents) {
  // `e` is a tuple of [dest, content]
  return Promise.all(destsContents.toArray().map(function (e) {
    return DocumentDownloader.install(e[0], e[1]);
  }));
};

/**
 * Checks if a given filename is allowed to be published by the system.
 *
 * @param {string} filename - The filename to check against
 * @returns {boolean} `true` if the filename is allowed, `false` otherwise
 */
DocumentDownloader.isAllowed = function isAllowed(filename) {
  if (filename.toLowerCase().indexOf('.htaccess') !== -1) return false;
  else if (filename.toLowerCase().indexOf('.php') !== -1) return false;
  else if (filename.indexOf('CVS') !== -1) return false;
  else if (filename.indexOf('../') !== -1) return false;
  else if (filename.indexOf('://') !== -1) return false;
  else return true;
};

DocumentDownloader.fetchAndInstall = function (url, dest) {
  var _ = DocumentDownloader; // Class name shortener
  var mkdir = Promise.denodeify(Fs.mkdir);

  return new Promise(function (resolve) {
    Fs.access(dest, Fs.constants.F_OK, function (error) { resolve(!error); });
  }).then(function (pathExists) {
    if (!pathExists) return mkdir(dest);
  }).then(function () {
    return _.fetch(url).then(function (content) {
      var fileType = require('file-type');
      return fileType.fromBuffer(content).then( type => {
        if (type &amp;&amp; type.mime !== 'application/x-tar') {
          throw new TypeError('Only tar, html and manifest are supported.');
        }
        else if (type &amp;&amp; type.mime === 'application/x-tar') {
          return new Promise(function (resolve, reject) {
            var tar = require('tar-stream');
            var extract = tar.extract();
            var hasOverview = false;

            extract.on('entry', function (header, stream, callback) {
              stream.on('data', function (data) {
                if (_.isAllowed(header.name)) {
                  if (header.name === 'Overview.html') {
                    hasOverview = true;
                  }
                  var path = require('path').dirname(dest + '/' + header.name);

                  Mkdirp.sync(path);
                  Fs.writeFileSync(dest + '/' + header.name, data);
                }
              });
              stream.on('end', function () {
                callback();
              });
            });
            extract.on('finish', function () {
              return (hasOverview) ? resolve() :
                reject(
                  new Error('No Overview.html in the tarball.')
                );
            });
            extract.end(content);
          });
        }
        else {
          var contentUtf8 = content.toString('utf8');

          if (contentUtf8.trim().charAt(0) !== '&lt;') {
            var filenames = _.getFilenames(contentUtf8).filter(_.isAllowed);

            var dests = filenames
              .set(0, 'Overview.html')
              .map(function (filename) { return dest + '/' + filename; });

            var urls = filenames.map(function (filename) {
              // If an entry in the manifest had a space in it,
              // we assume it needs to be built from the spec-generator.
              // See https://github.com/w3c/spec-generator
              var specGeneratorComp = filename.split(' ');
              var absUrl = new Url.URL(specGeneratorComp[0], url);

              if (specGeneratorComp.length === 2) {
                return global.SPEC_GENERATOR +
                  '?type=' + encodeURIComponent(specGeneratorComp[1]) +
                  '&amp;url=' + encodeURIComponent(absUrl);
              }
              return absUrl;
            });

            return _.fetchAll(urls).then(function (contents) {
              return _.installAll(dests.zip(contents));
            });
          }
          else return _.install(dest + '/Overview.html', content);
        }
      });
    });
  });
};

DocumentDownloader.getFilenames = function getFilenames(manifest) {
  return manifest.split('\n').reduce(function (acc, line) {
    var filename = line.split('#')[0].trim();

    if (filename !== '') return acc.push(filename);
    else return acc;
  }, new List());
};

module.exports = DocumentDownloader;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Welcome to Echidna</a></h2><h3>Modules</h3><ul><li><a href="lib_job.module_js.html">lib/job.js</a></li><li><a href="module-lib_document-downloader.html">lib/document-downloader</a></li><li><a href="module-lib_history.html">lib/history</a></li><li><a href="module-lib_json-http-service.html">lib/json-http-service</a></li><li><a href="module-lib_orchestrator.html">lib/orchestrator</a></li><li><a href="module-lib_publisher.html">lib/publisher</a></li><li><a href="module-lib_request-state.html">lib/request-state</a></li><li><a href="module-lib_specberus-wrapper.html">lib/specberus-wrapper</a></li><li><a href="module-lib_third-party-resources-checker.html">lib/third-party-resources-checker</a></li><li><a href="module-lib_token-checker.html">lib/token-checker</a></li><li><a href="module-lib_transition-checker.html">lib/transition-checker</a></li><li><a href="module-lib_user-checker.html">lib/user-checker</a></li><li><a href="module-test_lib_BadRequestService.html">test/lib/BadRequestService</a></li><li><a href="module-test_lib_CreatedService.html">test/lib/CreatedService</a></li><li><a href="module-test_lib_htmlTemplate.html">test/lib/htmlTemplate</a></li><li><a href="module-test_lib_NotImplementedService.html">test/lib/NotImplementedService</a></li><li><a href="module-test_lib_ServerErrorService.html">test/lib/ServerErrorService</a></li><li><a href="module-test_lib_TestServer.html">test/lib/TestServer</a></li><li><a href="module-test_lib_utils_draftsSystemPath.html">test/lib/utils/draftsSystemPath</a></li><li><a href="module-test_lib_utils_getMetadata.html">test/lib/utils/getMetadata</a></li><li><a href="module-test_lib_utils_substitutions.html">test/lib/utils/substitutions</a></li><li><a href="module-test_lib_validator.html">test/lib/validator</a></li><li><a href="module-test_test.html">test/test</a></li><li><a href="module-test_test-history.html">test/test-history</a></li><li><a href="module-test_test-job.html">test/test-job</a></li><li><a href="module-test_test-json-http-service.html">test/test-json-http-service</a></li><li><a href="module-test_test-orchestrator.html">test/test-orchestrator</a></li><li><a href="module-test_test-request-state.html">test/test-request-state</a></li></ul><h3>Global</h3><ul><li><a href="global.html#corsHandler">corsHandler</a></li><li><a href="global.html#processRequest">processRequest</a></li><li><a href="global.html#sendMessage">sendMessage</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Tue Jul 14 2020 12:32:36 GMT+0800 (China Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
